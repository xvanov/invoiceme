[phases.setup]
nixPkgs = ["jdk21", "maven"]

[phases.build]
cmds = [
    "export JAVA_HOME=$(find /nix/store -maxdepth 3 -type d -name 'openjdk-21*' 2>/dev/null | head -1)",
    "if [ -z \"$JAVA_HOME\" ]; then export JAVA_HOME=$(find /nix/store -maxdepth 4 -type d -name 'jdk-21*' 2>/dev/null | head -1); fi",
    "if [ -z \"$JAVA_HOME\" ]; then export JAVA_HOME=$(ls -d /nix/store/*/openjdk-21* 2>/dev/null | head -1); fi",
    "if [ -z \"$JAVA_HOME\" ]; then export JAVA_HOME=$(readlink -f $(which java) | sed 's|/bin/java||'); fi",
    "export PATH=$JAVA_HOME/bin:$PATH",
    "echo \"=== Java Environment ===\"",
    "echo \"JAVA_HOME=$JAVA_HOME\"",
    "java -version 2>&1",
    "echo \"=== Maven Environment ===\"",
    "mvn -version 2>&1",
    "echo \"=== Building with Maven ===\"",
    "JAVA_HOME=$JAVA_HOME PATH=$JAVA_HOME/bin:$PATH mvn clean package -DskipTests -DskipTests=true -Dmaven.compiler.release=21"
]

[phases.start]
cmd = "java -Dserver.port=$PORT -Dspring.profiles.active=prod $JAVA_OPTS -jar target/invoiceme-1.0.0.jar"

